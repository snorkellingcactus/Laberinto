<html>
<head>
<script type="text/javascript" src="./pared.js"></script>
<script type="text/javascript" src="./teclado.js"></script>
<script type="text/javascript" src="./charl.js"></script>
<script type="text/javascript" src="creaParedes.js"></script>
<script type="text/javascript" src="mat.js"></script>
<link rel="stylesheet" type="text/css" href="./index.css" />
</head>
<body>

<span id="string"></span>
<div Id="caja"></div>
<input type="hidden" id="teclado"/>

	<script>
				function cargaMapaLocal()
				{
					var j=0;
					
					while(!!localStorage["posX"+j]&&j<2000)
					{
						paredA.puntosCol.push
						(
							new PuntoCol
							(
								parseInt(localStorage["posX"+j]),
								parseInt(localStorage["posY"+j])
							)
						)
						j++;
					}
					graficaPared(paredA);
				}
				function genPuntos(event)
				{
					if(localStorage.length)
					{
						return 0;
					}
					var nCol=paredA.puntosCol.length-1;
					
					paredA.procesaPuntos
					(
						[
							[event.pageX,event.pageY]
						]
					)
					if(Hipo(event.pageX-pared.puntosCol[0].posX,event.pageY-pared.puntosCol[0].posY)<20)
					{
						paredA.procesaPuntos
						(
							[
								[
									pared.puntosCol[0].posX,
									pared.puntosCol[0].posY
								]
							]
						)
						
						localStorage.clear();
						for(var j=0;j<paredA.puntosCol.length;j++)
						{
							localStorage["posX"+j]=paredA.puntosCol[j].posX;
							localStorage["posY"+j]=paredA.puntosCol[j].posY;
						}
					}
					
					for(var i=nCol;i<paredA.puntosCol.length-1;i++)
					{
						var pCol=pared.puntosCol[i];
						var pColSig=pared.puntosCol[i+1];
						document.body.appendChild
						(
							graficaPuntos(pCol , pColSig)
						);
					}
				}
				document.body.addEventListener
				(
					"click",
					genPuntos
				);
				
				paredA=new Pared();
				
				if(!localStorage.length)
				{
					var paredA=creaMapa
					(
						0,
						[
							[50,50],
							[100,50]
						],
						[
							20,
							30
						]
					);
				}
				else
				{
					cargaMapaLocal();
				}
				
				function puntosColCercanos()
				{
					var posX=charl.posX;
					var posY=charl.posY;
					var puntosCol=[0,0,0,0];
					var distSupDer=Hipo(paredA.puntosCol[0].posX-posX,paredA.puntosCol[0].posY-posY);
					var distInfDer=Hipo(paredA.puntosCol[0].posX-posX,paredA.puntosCol[0].posY-posY);;
					var distSupIzq=Hipo(posX-paredA.puntosCol[0].posX,posY-paredA.puntosCol[0].posY);;
					var distInfIzq=Hipo(paredA.puntosCol[0].posX-posX,paredA.puntosCol[0].posY-posY);;
					var j=1;
					while(j<paredA.puntosCol.length)
					{
					 var colAct=paredA.puntosCol[j];
					 
					 var dist=Hipo(posX-colAct.posX,posY-colAct.posY);
					 
						if(colAct.posY>posY&&colAct.posX<posX)
						{
							if(dist<distSupIzq)
							{
								distSupIzq=dist;
								puntosCol[2]=j;
							}
						}
						if(colAct.posY<posY&&colAct.posX<posX)
						{
							if(dist<distInfIzq)
							{
								distInfIzq=dist;
								puntosCol[3]=j;
							}
						}
						if(colAct.posY>posY&&colAct.posX>posX)
						{
							if(dist<distSupDer)
							{
								distSupDer=dist;
								puntosCol[0]=j;
							}
						}
						if(colAct.posY<posY&&colAct.posX>posX)
						{
							if(dist<distInfDer)
							{
								distInfDer=dist;
								puntosCol[1]=j;
							}
						}
						j++
					}
					
					for(j=0;j<puntosCol.length;j++)
					{
						window.console.log("PuntoCol N "+puntosCol[j]+" :");
						window.console.log(paredA.puntosCol[puntosCol[j]]);
						window.console.log(document.getElementsByTagName("span")[puntosCol[j]+1])
					}
				}
				charl=new Tipito
				(
					80,
					80
				);
				charl.refresca=function()
				{
					document.getElementById("caja").style.left=this.posX+"px";
					document.getElementById("caja").style.top=this.posY+"px";
				};
				charl.refresca();
				
				/*verifCol=new VerifCol
				(
					new PuntoCol
					(
						charl.posX,
						charl.posY
					),
					paredA.puntosCol[0].posY,
					paredB.puntosCol[5].posY,
					paredA.puntosCol[3].posX,
					paredB.puntosCol[3].posX
				)*/
				
				mueveIzq=new TeclaEvt
				(
					{
						jugador:charl,
						keydown:function()
						{
							this.jugador.setPosX(-2);
							this.jugador.refresca();
						}
					}
				);
				
				mueveDer=new TeclaEvt
				(
					{
						jugador:charl,
						keydown:function()
						{
							this.jugador.setPosX(2);
							this.jugador.refresca();
						}
					}
				);
				
				mueveAr=new TeclaEvt
				(
					{
						jugador:charl,
						keydown:function()
						{
							this.jugador.setPosY(-2);
							this.jugador.refresca();
						}
					}
				);
				
				mueveAb=new TeclaEvt
				(
					{
						jugador:charl,
						keydown:function()
						{
							this.jugador.setPosY(2);
							this.jugador.refresca();
						}
					}
				);
				borraMapaLocal=new TeclaEvt
				(
					{
						jugador:charl,
						keypress:function()
						{
							localStorage.clear();
						}
					}
				);
				capTeclado=new Teclado();
				capTeclado.nEvt(39 , mueveDer);
				capTeclado.nEvt(37 , mueveIzq);
				capTeclado.nEvt(38 , mueveAr);
				capTeclado.nEvt(40 , mueveAb);
				capTeclado.nEvt(8 , borraMapaLocal);
				
				
				document.body.addEventListener
				(
					"keydown",
					function(event)
					{
						capTeclado.detona(event)
					}
				);
				document.body.addEventListener
				(
					"keyup",
					function(event)
					{
						capTeclado.detona(event)
					}
				);
				
		</script>
</body>
</html>